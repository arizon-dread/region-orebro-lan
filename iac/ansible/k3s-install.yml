---
- name: Install k3s with Cilium and Traefik on Debian
  hosts: k3s
  become: true

  vars:
    k3s_version: ""
    k3s_exec_args: >-
      --write-kubeconfig-mode=644
      --flannel-backend=none
      --disable-network-policy
      --disable=traefik
    cilium_version: "1.15.5"
  
  tasks:
    # Install required packages
    - name: Install base packages
      apt:
        name:
          - curl
          - ca-certificates
          - iptables
          - ufw
        state: present
        update_cache: yes

    # Disable swap
    - name: Disable swap
      command: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Remove swap from fstab
      replace:
        path: /etc/fstab
        regexp: '^([^#].*\sswap\s.*)$'
        replace: '# \1'

    # Load kernel modules
    - name: Load kernel modules
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter

    # Enable kernel modules
    - name: Enable kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    # Set sysctl parameters
    - name: Set sysctl parameters
      copy:
        dest: /etc/sysctl.d/99-kubernetes.conf
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1

    - name: Apply sysctl
      command: sysctl --system

    # --------------------
    # K3S INSTALL
    # --------------------
    - name: Install k3s with Traefik enabled
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="{{ k3s_version }}" INSTALL_K3S_EXEC="--write-kubeconfig-mode=644 --flannel-backend=none --disable-network-policy" sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for k3s kubeconfig
      wait_for:
        path: /etc/rancher/k3s/k3s.yaml
        timeout: 60

    # --------------------
    # HELM
    # --------------------
    - name: Install Helm
      shell: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    # --------------------
    # CILIUM
    # --------------------
    - name: Add Cilium Helm repo
      shell: helm repo add cilium https://helm.cilium.io
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Update Helm repos
      shell: helm repo update
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Install Cilium
      shell: >
        helm install cilium cilium/cilium
        --version {{ cilium_version }}
        --namespace kube-system
        --set kubeProxyReplacement=true
        --set k8sServiceHost=127.0.0.1
        --set k8sServicePort=6443
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Wait for Cilium pods
      shell: kubectl -n kube-system rollout status ds/cilium
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    # --------------------
    # TRAEFIK
    # --------------------
    - name: Install Traefik ingress controller
      shell: >
        helm install traefik traefik/traefik
        --namespace kube-system
        --create-namespace
        --set deployment.kind=DaemonSet
        --set hostNetwork=true
        --set dnsPolicy=ClusterFirstWithHostNet
        --set ports.web.port=80
        --set ports.websecure.port=443
        --set service.enabled=false
        --set securityContext.privileged=true
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Wait for Traefik pods
      shell: kubectl -n kube-system rollout status ds/traefik
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
