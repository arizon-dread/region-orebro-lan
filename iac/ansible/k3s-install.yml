---
- name: Install k3s with Cilium on Debian
  hosts: k3s
  become: true

  vars:
    k3s_version: ""
    k3s_exec_args: >-
      --write-kubeconfig-mode=644
      --flannel-backend=none
      --disable-network-policy
      --disable=traefik

    cilium_version: "1.15.5"

  tasks:
    - name: Install base packages
      apt:
        name:
          - curl
          - ca-certificates
          - iptables
          - ufw
        state: present
        update_cache: yes

    - name: Disable swap
      command: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Remove swap from fstab
      replace:
        path: /etc/fstab
        regexp: '^([^#].*\sswap\s.*)$'
        replace: '# \1'

    - name: Load kernel modules
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter

    - name: Enable kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    - name: Set sysctl parameters
      copy:
        dest: /etc/sysctl.d/99-kubernetes.conf
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1

    - name: Apply sysctl
      command: sysctl --system

    # --------------------
    # K3S INSTALL
    # --------------------
    - name: Install k3s (no flannel)
      shell: |
        curl -sfL https://get.k3s.io | \
        INSTALL_K3S_VERSION="{{ k3s_version }}" \
        INSTALL_K3S_EXEC="{{ k3s_exec_args }}" \
        sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for k3s kubeconfig
      wait_for:
        path: /etc/rancher/k3s/k3s.yaml
        timeout: 60

    # --------------------
    # HELM
    # --------------------
    - name: Install Helm
      shell: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    # --------------------
    # CILIUM
    # --------------------
    - name: Add Cilium Helm repo
      command: helm repo add cilium https://helm.cilium.io
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Update Helm repos
      command: helm repo update
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Install Cilium
      command: >
        helm install cilium cilium/cilium
        --version {{ cilium_version }}
        --namespace kube-system
        --set kubeProxyReplacement=true
        --set k8sServiceHost=127.0.0.1
        --set k8sServicePort=6443
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Wait for Cilium pods
      command: kubectl -n kube-system rollout status ds/cilium
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
